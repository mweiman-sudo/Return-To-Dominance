<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Tracker - Return to Dominance</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        html { scroll-behavior: smooth; }
        /* Style for selected emoji - UPDATED TO RED */
        .mood-selected {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); /* red-500 shadow */
            background: #fef2f2; /* red-50 */
        }
    </style>
    
    <!-- Tailwind Configuration (UPDATED TO RED THEME) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            light: '#f87171', // red-400 (Poppy Light)
                            DEFAULT: '#ef4444', // red-500 (Poppy Red)
                            dark: '#dc2626', // red-600 (Poppy Dark)
                        },
                        secondary: {
                            light: '#f3f4f6', // gray-100
                            DEFAULT: '#e5e7eb', // gray-200
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-secondary-light text-gray-800">

    <!-- Header & Navigation -->
    <nav class="bg-white shadow-md fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <!-- Logo -->
                <a href="./index.html" class="text-2xl font-bold text-primary-dark">
                        Return to Dominance
                </a>
                
                <!-- Desktop Nav -->
                <div class="hidden md:flex space-x-6 items-center">
                    <a href="./index.html" class="text-gray-600 hover:text-primary transition duration-200">Home</a>
                    <a href="./mood-tracker.html" class="text-primary font-semibold transition duration-200">Mental Health</a>
                    <a href="#" class="text-gray-600 hover:text-primary transition duration-200">Videos</a>
                    <a href="./index.html#cta" class="bg-primary hover:bg-primary-dark text-white font-semibold px-5 py-2 rounded-lg transition duration-200 shadow-sm">
                        Get Started
                    </a>
                </div>
                
                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button id="menu-btn" class="text-gray-700 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Menu -->
            <div id="mobile-menu" class="hidden md:hidden mt-4 space-y-2">
                <a href="./index.html" class="block px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Home</a>
                <!-- Updated background to red-50 -->
                <a href="./mood-tracker.html" class="block px-4 py-2 text-primary bg-red-50 rounded-lg">Mental Health</a>
                <a href="#" class="block px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Videos</a>
                <a href="./index.html#cta" class="block px-4 py-2 bg-primary text-white font-semibold rounded-lg text-center">
                    Get Started
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-32 pb-24 min-h-screen">
        <div class="container mx-auto px-6">
            
            <!-- Header -->
            <div class="text-center max-w-2xl mx-auto">
                <h1 class="text-3xl md:text-5xl font-extrabold text-gray-900">Mental Health Check-in</h1>
                <p class="mt-4 text-lg text-gray-600">
                    Recovery isn't just physical. Taking a moment to check in with your feelings is a key part of getting back to 100%.
                </p>
                <!-- User ID will be shown here -->
                <p id="auth-status" class="mt-4 text-sm text-gray-500">Connecting to secure log...</p>
            </div>
            
            <!-- Mood Logger -->
            <div class="mt-16 max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-900 text-center">How are you feeling today?</h2>
                <p class="text-center text-gray-500 text-sm" id="today-date">Loading...</p>
                
                <!-- Mood Emojis -->
                <div class="mt-8 flex justify-around items-center">
                    <div class="mood-option p-3 rounded-full cursor-pointer transition-all duration-200" data-mood="terrible" aria-label="Terrible">
                        <span class="text-5xl md:text-6xl">üòû</span>
                    </div>
                    <div class="mood-option p-3 rounded-full cursor-pointer transition-all duration-200" data-mood="bad" aria-label="Bad">
                        <span class="text-5xl md:text-6xl">üòü</span>
                    </div>
                    <div class="mood-option p-3 rounded-full cursor-pointer transition-all duration-200" data-mood="ok" aria-label="OK">
                        <span class="text-5xl md:text-6xl">üòê</span>
                    </div>
                    <div class="mood-option p-3 rounded-full cursor-pointer transition-all duration-200" data-mood="good" aria-label="Good">
                        <span class="text-5xl md:text-6xl">üôÇ</span>
                    </div>
                    <div class="mood-option p-3 rounded-full cursor-pointer transition-all duration-200" data-mood="great" aria-label="Great">
                        <span class="text-5xl md:text-6xl">üòÑ</span>
                    </div>
                </div>
                
                <button id="save-mood-btn" class="mt-8 w-full bg-primary text-white font-semibold py-3 rounded-lg shadow-md transition duration-200 hover:bg-primary-dark disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                    Save Today's Mood
                </button>
                <p id="save-status" class="text-center text-green-600 mt-2 h-4"></p>
                
                <!-- NEW SUGGESTION BOX (starts hidden) - Updated background to red-50 -->
                <div id="suggestion-box" class="hidden mt-6 p-4 bg-red-50 border border-primary-light rounded-lg">
                    <h3 class="font-semibold text-lg text-primary-dark">A Quick Thought...</h3>
                    <p id="suggestion-text" class="text-gray-700 mt-2">Here is a helpful suggestion.</p>
                </div>
            </div>
            
            <!-- This Week's Log -->
            <div class="mt-16 max-w-4xl mx-auto">
                <h2 class="text-2xl font-semibold text-gray-900 text-center mb-8">This Week's Log</h2>
                <div class="grid grid-cols-3 sm:grid-cols-7 gap-4 text-center">
                    <!-- Day boxes will be populated by JavaScript -->
                    <div id="day-0" class="bg-white p-4 rounded-lg shadow aspect-square flex flex-col justify-center items-center">
                        <span class="font-bold text-gray-800 text-sm md:text-base">Mon</span>
                        <span class="text-4xl mt-2">...</span>
                    </div>
                    <div id="day-1" class="bg-white p-4 rounded-lg shadow aspect-square flex flex-col justify-center items-center">
                        <span class="font-bold text-gray-800 text-sm md:text-base">Tue</span>
                        <span class="text-4xl mt-2">...</span>
                    </div>
                    <div id="day-2" class="bg-white p-4 rounded-lg shadow aspect-square flex flex-col justify-center items-center">
                        <span class="font-bold text-gray-800 text-sm md:text-base">Wed</span>
                        <span class="text-4xl mt-2">...</span>
                    </div>
                    <div id="day-3" class="bg-white p-4 rounded-lg shadow aspect-square flex flex-col justify-center items-center">
                        <span class="font-bold text-gray-800 text-sm md:text-base">Thu</span>
                        <span class="text-4xl mt-2">...</span>
                    </div>
                    <div id="day-4" class="bg-white p-4 rounded-lg shadow aspect-square flex flex-col justify-center items-center">
                        <span class="font-bold text-gray-800 text-sm md:text-base">Fri</span>
                        <span class="text-4xl mt-2">...</span>
                    </div>
                    <div id="day-5" class="bg-white p-4 rounded-lg shadow aspect-square flex flex-col justify-center items-center">
                        <span class="font-bold text-gray-800 text-sm md:text-base">Sat</span>
                        <span class="text-4xl mt-2">...</span>
                    </div>
                    <div id="day-6" class="bg-white p-4 rounded-lg shadow aspect-square flex flex-col justify-center items-center">
                        <span class="font-bold text-gray-800 text-sm md:text-base">Sun</span>
                        <span class="text-4xl mt-2">...</span>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-400 py-16">
        <div class="container mx-auto px-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <!-- Logo & Copyright -->
                <div class="text-center md:text-left mb-6 md:mb-0">
                    <a href="./index.html" class="text-2xl font-bold text-white">
                        Return to Dominance
                    </a>
                    <p class="mt-2 text-sm">
                        &copy; 2025 Rebound Rehab Inc. All rights reserved.
                    </p>
                </div>
                
                <!-- Footer Links -->
                <div class="flex space-x-8">
                    <a href="./index.html#how-it-works" class="hover:text-white transition duration-200">How It Works</a>
                    <a href="./index.html#benefits" class="hover:text-white transition duration-200">Benefits</a>
                    <a href="#" class="hover:text-white transition duration-200">Privacy Policy</a>
                    <a href="#" class="hover:text-white transition duration-200">Contact</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES ---
        let db, auth;
        let userId;
        let selectedMood = null;
        const moodEmojis = {
            'terrible': 'üòû',
            'bad': 'üòü',
            'ok': 'üòê',
            'good': 'üôÇ',
            'great': 'üòÑ',
            'default': '...'
        };

        // NEW: Mood Suggestions
        const moodSuggestions = {
            'terrible': [
                "It's completely okay to have tough days. Be kind to yourself. Maybe just focus on one small thing, like drinking a glass of water or stretching for 5 minutes.",
                "Feeling this way is hard, but it's temporary. If you feel comfortable, try talking to a friend, family member, or a trusted adult about what's on your mind.",
                "Your feelings are valid. Sometimes a change of scenery helps, even just stepping outside for 60 seconds of fresh air."
            ],
            'bad': [
                "Sorry to hear you're having a bad day. Could you write down one thing you're grateful for, no matter how small? It can sometimes help shift your perspective.",
                "It's tough when you're in a funk. Maybe listen to a favorite song or podcast to give your mind a break.",
                "Remember that your worth isn't defined by one day. Try to do a simple, kind act for yourself, like tidying up one small spot."
            ],
            'ok': [
                "'OK' is a perfectly fine place to be. It's a good time to check in: Are you hydrated? Have you eaten? A small snack or some water can make a big difference.",
                "Feeling 'ok'? This is a great time to just pause. Take 10 deep breaths, in and out. Notice the quiet.",
                "A neutral day is a good foundation. What's one small thing you could do right now that your 'future self' would thank you for?"
            ],
            'good': [
                "That's great! Try to pause and notice *why* you're feeling good. What's going right? Savor this moment.",
                "Awesome! Good feelings can build on themselves. Maybe share that positivity‚Äîsend a nice text to a friend or family member.",
                "Glad to hear you're feeling good! This is a great time to tackle a small task you've been putting off. Use that positive energy!"
            ],
            'great': [
                "Amazing! Ride that wave of positive energy. It's a great time to be active or creative. Enjoy it!",
                "Fantastic! Remember this feeling. What contributed to it? See if you can plan to do more of that this week.",
                "Keep that great energy going! Maybe do something kind for someone else to spread the good vibes."
            ]
        };

        // --- DOM Elements ---
        const menuBtn = document.getElementById('menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const authStatusEl = document.getElementById('auth-status');
        const todayDateEl = document.getElementById('today-date');
        const moodOptions = document.querySelectorAll('.mood-option');
        const saveMoodBtn = document.getElementById('save-mood-btn');
        const saveStatusEl = document.getElementById('save-status');
        
        // NEW: Suggestion Box Elements
        const suggestionBoxEl = document.getElementById('suggestion-box');
        const suggestionTextEl = document.getElementById('suggestion-text');

        const dayElements = [
            document.getElementById('day-0'),
            document.getElementById('day-1'),
            document.getElementById('day-2'),
            document.getElementById('day-3'),
            document.getElementById('day-4'),
            document.getElementById('day-5'),
            document.getElementById('day-6')
        ];

        // --- DATE HELPERS ---
        // Get YYYY-MM-DD string for a date
        function getYYYYMMDD(date) {
            return date.toISOString().split('T')[0];
        }

        // Get the start of the current week (Monday)
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday (0)
            return new Date(d.setDate(diff));
        }

        // --- UI FUNCTIONS ---
        
        // Mobile Menu Toggle
        menuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        
        // Set today's date
        const today = new Date();
        todayDateEl.textContent = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // Mood selection
        moodOptions.forEach(option => {
            option.addEventListener('click', () => {
                // Remove previous selection
                moodOptions.forEach(opt => opt.classList.remove('mood-selected'));
                
                // Add new selection
                option.classList.add('mood-selected');
                selectedMood = option.dataset.mood;
                
                // Enable button
                saveMoodBtn.disabled = false;
                saveStatusEl.textContent = '';
                
                // NEW: Hide suggestion box on new selection
                suggestionBoxEl.classList.add('hidden');
            });
        });

        // Update the weekly display
        function updateWeekDisplay(moods) {
            const startOfWeek = getStartOfWeek(new Date());
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            for (let i = 7; i < 7; i++) { // Corrected from i=7 to i=0 in logic below
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dateString = getYYYYMMDD(day);
                
                const dayBox = dayElements[i];
                const dayNameEl = dayBox.querySelector('span:first-child');
                const emojiEl = dayBox.querySelector('span:last-child');
                
                dayNameEl.textContent = dayNames[i];
                
                // Find mood for this day
                const moodData = moods.find(m => m.date === dateString);
                emojiEl.textContent = moodData ? moodEmojis[moodData.mood] : moodEmojis['default'];
                
                // Highlight today
                if (dateString === getYYYYMMDD(new Date())) {
                    dayNameEl.classList.add('text-primary-dark', 'font-bold');
                    dayBox.classList.add('border-2', 'border-primary');
                } else {
                    dayNameEl.classList.remove('text-primary-dark', 'font-bold');
                    dayBox.classList.remove('border-2', 'border-primary');
                }
            }
            // Correct Loop:
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dateString = getYYYYMMDD(day);
                
                const dayBox = dayElements[i];
                const dayNameEl = dayBox.querySelector('span:first-child');
                const emojiEl = dayBox.querySelector('span:last-child');
                
                dayNameEl.textContent = dayNames[i];
                
                // Find mood for this day
                const moodData = moods.find(m => m.date === dateString);
                emojiEl.textContent = moodData ? moodEmojis[moodData.mood] : moodEmojis['default'];
                
                // Highlight today
                if (dateString === getYYYYMMDD(new Date())) {
                    dayNameEl.classList.add('text-primary-dark', 'font-bold');
                    dayBox.classList.add('border-2', 'border-primary');
                } else {
                    dayNameEl.classList.remove('text-primary-dark', 'font-bold');
                    dayBox.classList.remove('border-2', 'border-primary');
                }
            }
        }

        // NEW: Show Suggestion Function
        function showSuggestion(mood) {
            if (moodSuggestions[mood]) {
                const suggestions = moodSuggestions[mood];
                // Pick a random suggestion from the list
                const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
                
                suggestionTextEl.textContent = randomSuggestion;
                suggestionBoxEl.classList.remove('hidden');
            } else {
                suggestionBoxEl.classList.add('hidden'); // Hide if no mood
            }
        }

        // --- FIREBASE FUNCTIONS ---

        // 1. Initialize Firebase and Auth
        async function initFirebase() {
            try {
                // Get config and app ID from (hidden) global vars
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (!firebaseConfig.apiKey) {
                    authStatusEl.textContent = "Error: Firebase config missing.";
                    console.error("Firebase config is missing.");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set log level for debugging
                // setLogLevel('debug');

                // 2. Sign In
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        authStatusEl.textContent = `Your private log ID: ${userId}`;
                        console.log("User signed in with UID:", userId);
                        
                        // 3. Start listening for mood data
                        listenForMoods(appId, userId);
                    } else {
                        // User is signed out
                        authStatusEl.textContent = "Not signed in.";
                        console.log("User is not signed in.");
                    }
                });

                // Try signing in with token, fall back to anonymous
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Init Error:", error);
                authStatusEl.textContent = "Error connecting to log.";
            }
        }

        // 3. Listen for mood data
        function listenForMoods(appId, uid) {
            const colPath = `/artifacts/${appId}/users/${uid}/moods`;
            const q = query(collection(db, colPath));

            onSnapshot(q, (snapshot) => {
                const moods = [];
                snapshot.forEach((doc) => {
                    moods.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort moods by date (descending) in JS
                moods.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                console.log("Loaded moods:", moods);
                updateWeekDisplay(moods);

            }, (error) => {
                console.error("Error listening to moods:", error);
                saveStatusEl.textContent = "Error loading moods.";
            });
        }

        // 4. Save mood data
        async function saveMood() {
            if (!selectedMood || !userId) {
                saveStatusEl.textContent = "Please select a mood first.";
                return;
            }

            saveMoodBtn.disabled = true;
            saveStatusEl.textContent = "Saving...";

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const todayString = getYYYYMMDD(new Date());
                
                // Use YYYY-MM-DD as the document ID to easily overwrite/update today's mood
                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/moods`, todayString);
                
                const moodData = {
                    date: todayString,
                    mood: selectedMood,
                    timestamp: serverTimestamp()
                };

                // setDoc will create or overwrite the doc for today
                await setDoc(docRef, moodData);

                saveStatusEl.textContent = "Saved!";
                
                // NEW: Show suggestion
                showSuggestion(selectedMood);

                setTimeout(() => {
                    saveStatusEl.textContent = "";
                    saveMoodBtn.disabled = false;
                    // Deselect mood
                    moodOptions.forEach(opt => opt.classList.remove('mood-selected'));
                    selectedMood = null;
                }, 2000);

            } catch (error) {
                console.error("Error saving mood:", error);
                saveStatusEl.textContent = "Error saving. Try again.";
                saveMoodBtn.disabled = false;
            }
        }
        
        // --- EVENT LISTENERS ---
        saveMoodBtn.addEventListener('click', saveMood);
        
        // --- START APP ---
        initFirebase();

    </script>
</body>
</html>
